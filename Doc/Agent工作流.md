# Agent 工作流总览

知旅系统的核心由推荐智能体（Recommendation Agents）与社区智能体（Community Agents）两大模块构成。两者均依托 MCP 协同总线进行任务调度，并共享 RAG 知识库、实时数据服务、用户画像与行为日志。以下分步骤说明整体流程及关键节点，供制作流程图使用。

## 一、推荐智能体工作流（Recommendation Agents）

### 1. 触发入口
1. 用户在 Web/App 前端提交问卷或自然语言需求（如“帮我规划上海三日游”）。
2. 前端将结构化数据与原始问题一并发送给 MCP。

### 2. 画像构建与更新
1. MCP 将请求转发给画像 Agent：
   - 读取用户历史画像（偏好标签、预算、出行习惯、敏感项等）。
   - 融合本次问卷输入，生成新的画像向量（显性特征 + 隐性反馈）。
   - 若是多人旅行，调用画像融合策略（交集 + 差异惩罚）。
2. 画像 Agent 将更新后的画像向量写回画像仓库，并同步给推荐轨迹树。

### 3. 候选召回阶段（“边想边搜”第一轮）
1. MCP 调用 LLM2Trip Pipeline 的召回层：
   - 基于画像向量对向量库中的 4000+ 城市 POI 做相似度匹配。
   - 同时检索知识库中的主题模板、必去清单、季节特征。
2. RAG 检索到的候选集合交由规则引擎过滤（去除不开放、重复或不符合基础约束的景点）。
3. 候选结果与画像相似度一并传递给规划 Agent。

### 4. 规划排布阶段
1. 规划 Agent 进行时段、线路和预算排布：
   - 根据画像偏好决定每日主题与节奏。
   - 调用调度服务对交通、时间进行排序（如 A* 搜索、旅行商近似等）。
2. 规划 Agent 并行调用“高德数据 Agent”：
   - 拉取实时天气、人流、路况、导航信息。
   - 将结果写入多源缓存，并反馈给调度服务校准路线。
3. 若检测到冲突（闭馆、超时、预算超出等），触发重排。

### 5. 解释与可视化准备
1. 规划 Agent 将初步行程、每个节点的评分因子交给 ReRanker 进行再排序（评分权重、风险惩罚、体验度等）。
2. 推荐轨迹树记录节点的来源、权重和风险标签。
3. LLM2Trip 的解释层将行程转为可读文案，生成推荐理由、风险提示、预算说明。

### 6. “边想边搜”迭代（第二轮及后续）
1. MCP 监控信息完整性，如果发现实时性字段（天气、活动、票价）存在缺口或过时：
   - 再次调度 RAG 検索外部渠道（高德 API、国家气象局、景区官网、交通部门）。
   - 将最新数据与既有方案比较，必要时触发局部重排。
2. 用户若提出追问或调整（如“想换亲子景点”），即进入新的循环：
   - MCP 将需求派发给问答 Agent。
   - 问答 Agent 先读取轨迹树和画像，再走一遍“检索 → 推理 → 提案”的流程，输出备选并引用数据源。
3. 最终行程与解释同步到前端展示。

### 7. 行程执行后的反馈闭环
1. 用户完成行程后可提交反馈问卷或评分。
2. MCP 调用自学习模块，将反馈写入画像与行程日志。
3. 画像 Agent、规划 Agent 更新权重，使模型在下一次推荐时更贴合个人偏好。

## 二、社区智能体工作流（Community Agents）

### 1. 触发入口
- 用户进入社区模块，浏览组队、话题、攻略或参与群聊。
- 前端记录行为事件，统一发送给 MCP。

### 2. 智能组队匹配
1. MCP 将组队请求交给社区画像 Agent：
   - 读取用户画像、出行时间、目的地、性格标签。
   - 计算与其他候选用户的相似度矩阵，并应用惩罚因子（避免冲突）。
2. 匹配结果提交给匹配策略引擎（稳定婚姻算法 / 轮盘赌），输出推荐队伍。
3. 生成的队伍信息推送到前端，并写入群聊服务。

### 3. 群聊与实时互动
1. 群聊使用 WebSocket + Supabase Realtime：
   - 新消息经由 MCP 路由，与情绪分析模型联动（检测风险、敏感词）。
   - 通过 RAG 检索历史话题生成“话题引导卡片”。
2. MCP 将重要对话同步给推荐轨迹树（如“不吃辣”“想住市中心”），以便行程推荐保持一致。

### 4. 活动与知识共建
1. Community Agent 调用知识库 Agent：
   - 推送与当前队伍目的地相关的攻略模板、注意事项。
   - 接收用户贡献的攻略，经过审核后回写知识库。
2. MCP 结合运营策略，自动派发任务（写游记、报名线下活动），并计算积分/勋章。

### 5. 数据看板与运营调度
1. 所有社区行为事件（组队成功率、活跃度、任务完成度）写入数据仓库。
2. 运营 Agent 通过 MCP 获取实时数据：
   - 若发现某类活动热度下降，会自动调高推荐权重或推送新的话题。
   - 若出现敏感舆情，触发安全审计智能体生成报告并通知管理员。

### 6. 与推荐模块的交互
1. 社区侧新增的画像信息直接同步给推荐模块（如聊天中提到的饮食禁忌）。
2. 推荐模块生成的行程或备选路线可一键分享到群聊，由群体共同讨论。
3. 行程执行后的反馈也能回写到社区，作为攻略或经验帖沉淀。

## 三、关键共享组件
- **MCP 协同总线**：负责分发任务、状态监控、错误恢复（守护进程保证 Agent 崩溃后重启）。
- **RAG 知识库**：统一管理结构化与非结构化内容（向量库 + 规则过滤 + 版本管理）。
- **实时数据服务**：对接高德 API、国家气象局、民航/铁路、文旅公告等，并在缓存层提供统一格式。
- **推荐轨迹树**：记录每一次推荐决策的节点、权重、数据来源，是问答和解释模块的依据。
- **数据看板与运营策略**：支持 A/B 测试、点击率预测、用户旅程分析，用于业务决策。

以上流程可拆分为泳道图或时序图展示。建议将推荐与社区两大模块分别成泳道，再用 MCP 作为中心协调，突出 RAG、实时数据、用户画像在两个模块中的共享与循环。
