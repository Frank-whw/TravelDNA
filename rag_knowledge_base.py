#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RAGçŸ¥è¯†åº“æ¨¡å— - ä¸ºæ™ºèƒ½æ—…è¡Œæ”»ç•¥æä¾›æ·±åº¦çŸ¥è¯†æ”¯æŒ
åŒ…å«æ™¯ç‚¹è¯¦ç»†ä¿¡æ¯ã€éšè—ç©æ³•ã€å®ç”¨è´´å£«ç­‰
"""

import json
import logging
from typing import Dict, List, Any, Optional
from datetime import datetime

logger = logging.getLogger(__name__)

class RAGKnowledgeBase:
    """RAGçŸ¥è¯†åº“ - ä¸Šæµ·æ—…æ¸¸æ·±åº¦çŸ¥è¯†"""
    
    def __init__(self):
        """åˆå§‹åŒ–RAGçŸ¥è¯†åº“"""
        
        # æ ¸å¿ƒæ™¯ç‚¹æ·±åº¦çŸ¥è¯†
        self.attractions_knowledge = {
            "å¤–æ»©": {
                "overview": "ä¸Šæµ·æœ€è‘—åçš„æ»¨æ±Ÿé£æ™¯çº¿ï¼Œæ±‡é›†äº†ä¸Šæµ·æ»©æœ€ç²¾åçš„åŸå¸‚æ™¯è§‚",
                "best_time": {
                    "optimal": "å‚æ™š18:00-20:00",
                    "reason": "æ—¥è½æ—¶åˆ†å¯ä»¥çœ‹åˆ°é»„æµ¦æ±Ÿä¸¤å²¸ä»ç™½å¤©åˆ°å¤œæ™šçš„å®Œç¾è¿‡æ¸¡",
                    "alternative": "æ—©ä¸Š7:00-9:00äººå°‘æ™¯ç¾ï¼Œé€‚åˆæ‹ç…§"
                },
                "photo_spots": [
                    {"name": "å¤–ç™½æ¸¡æ¡¥", "tip": "ç»å…¸è§’åº¦æ‹æ‘„æµ¦ä¸œå¤©é™…çº¿", "best_time": "æ—¥è½å‰30åˆ†é’Ÿ"},
                    {"name": "å’Œå¹³é¥­åº—è€æ¥¼", "tip": "å¤å¤å»ºç­‘ä¸ç°ä»£å»ºç­‘å¯¹æ¯”", "best_time": "ä»»ä½•æ—¶é—´"},
                    {"name": "åå…­é“ºç å¤´", "tip": "ä½æœºä½æ‹æ‘„å¤–æ»©å»ºç­‘ç¾¤", "best_time": "é»„æ˜æ—¶åˆ†"},
                    {"name": "å¤–æ»©æº33å·è§‚æ™¯å°", "tip": "å…è´¹è§‚æ™¯å°ï¼Œäººå°‘è§†é‡å¥½", "best_time": "é¿å¼€å‘¨æœ«"}
                ],
                "insider_tips": [
                    "é¿å¼€å›½åº†é»„é‡‘å‘¨ï¼Œäººæµæ˜¯å¹³æ—¶çš„5-10å€",
                    "å·¥ä½œæ—¥æ—©æ™¨æœ€å®‰é™ï¼Œé€‚åˆæ·±åº¦æ¸¸è§ˆ",
                    "å¤–æ»©18å·é¡¶å±‚é¤å…æ™¯è§‚ç»ä½³ä½†ä»·æ ¼æ˜‚è´µ",
                    "åœ°é“2å·çº¿å—äº¬ä¸œè·¯ç«™2å·å‡ºå£æœ€è¿‘"
                ],
                "hidden_gems": [
                    "å¤–æ»©æº33å·å…è´¹è§‚æ™¯å°ï¼Œå¾ˆå¤šäººä¸çŸ¥é“",
                    "å’Œå¹³é¥­åº—çˆµå£«é…’å§ï¼Œå‘¨äº”æ™šä¸Šæœ‰ç°åœºæ¼”å‡º",
                    "å¤–æ»©å†å²çºªå¿µé¦†ï¼Œäº†è§£å¤–æ»©ç™¾å¹´å˜è¿",
                    "å¤–æ»©éš§é“è§‚å…‰å»Šï¼Œç‹¬ç‰¹çš„æ±Ÿåº•ä½“éªŒ"
                ],
                "nearby_food": [
                    {"name": "å¤–æ»©18å·", "type": "é«˜ç«¯é¤å…", "specialty": "æ³•é¤", "price": "äººå‡500+", "view": "é»„æµ¦æ±Ÿæ™¯è§‚"},
                    {"name": "è€æ­£å…´", "type": "æœ¬å¸®èœ", "specialty": "ä¸Šæµ·èœ", "price": "äººå‡150", "note": "ç™¾å¹´è€åº—"},
                    {"name": "å°å—å›½", "type": "ç²¤èœ", "specialty": "æ¸¯å¼èŒ¶ç‚¹", "price": "äººå‡200", "note": "ç¯å¢ƒä¼˜é›…"},
                    {"name": "BFCå¤–æ»©é‡‘èä¸­å¿ƒ", "type": "ç¾é£ŸåŸ", "specialty": "å„å›½æ–™ç†", "price": "äººå‡80-200", "note": "é€‰æ‹©ä¸°å¯Œ"}
                ],
                "practical_info": {
                    "opening_hours": "å…¨å¤©å¼€æ”¾",
                    "ticket_price": "å…è´¹",
                    "transportation": ["åœ°é“2å·çº¿å—äº¬ä¸œè·¯ç«™", "åœ°é“10å·çº¿å—äº¬ä¸œè·¯ç«™", "å…¬äº¤20è·¯ã€37è·¯"],
                    "parking": "å¤–æ»©ä¸­å¿ƒåœè½¦åœºï¼Œ30å…ƒ/å°æ—¶",
                    "facilities": ["å…¬å…±æ´—æ‰‹é—´", "æ— éšœç¢é€šé“", "è§‚å…‰é•¿æ¤…"]
                }
            },
            
            "ä¸œæ–¹æ˜ç ": {
                "overview": "ä¸Šæµ·åœ°æ ‡æ€§å»ºç­‘ï¼Œ468ç±³é«˜çš„ç”µè§†å¡”ï¼Œæµ¦ä¸œæ–°åŒºçš„è±¡å¾",
                "best_time": {
                    "optimal": "æ—¥è½å‰1å°æ—¶ç™»å¡”",
                    "reason": "å¯ä»¥åŒæ—¶æ¬£èµåˆ°ç™½å¤©çš„åŸå¸‚å…¨æ™¯å’Œå¤œæ™šçš„ç’€ç’¨ç¯å…‰",
                    "alternative": "æ™´æœ—å¤©æ°”çš„ä¸Šåˆï¼Œèƒ½è§åº¦æœ€é«˜"
                },
                "photo_spots": [
                    {"name": "259ç±³ä¸»è§‚å…‰å±‚", "tip": "360åº¦å…¨æ™¯è§†è§’", "best_time": "æ—¥è½æ—¶åˆ†"},
                    {"name": "263ç±³æ‚¬ç©ºè§‚å…‰å»Š", "tip": "è„šä¸‹å°±æ˜¯ä¸Šæµ·", "best_time": "ç™½å¤©ï¼Œçœ‹å¾—æ›´æ¸…æ¥š"},
                    {"name": "å¤ªç©ºèˆ±", "tip": "ç§‘å¹»æ„Ÿåè¶³çš„æ‹ç…§èƒŒæ™¯", "best_time": "ä»»ä½•æ—¶é—´"},
                    {"name": "å¡”åº•å¹¿åœº", "tip": "ä»°æ‹æ•´ä¸ªæ˜ç å¡”", "best_time": "å¤œæ™šï¼Œé…åˆç¯å…‰æ•ˆæœ"}
                ],
                "insider_tips": [
                    "ç½‘ä¸Šè´­ç¥¨æ¯”ç°åœºä¾¿å®œçº¦30-50å…ƒ",
                    "ä¸‹è½½'ä¸œæ–¹æ˜ç 'APPå¯è·å¾—å¯¼è§ˆä¿¡æ¯",
                    "B1å±‚æœ‰å…è´¹çš„ä¸Šæµ·åŸå¸‚å†å²å‘å±•é™ˆåˆ—é¦†",
                    "é«˜å³°æœŸæ’é˜Ÿç­‰ç”µæ¢¯éœ€è¦30-60åˆ†é’Ÿ",
                    "259ç±³å’Œ263ç±³ç¥¨ä»·ä¸åŒï¼Œå»ºè®®é€‰æ‹©263ç±³å¥—ç¥¨"
                ],
                "hidden_gems": [
                    "é›¶ç±³å¤§å…çš„ä¸Šæµ·åŸå¸‚å†å²å‘å±•é™ˆåˆ—é¦†å…è´¹å‚è§‚",
                    "æ—‹è½¬é¤å…å¯ä»¥è¾¹ç”¨é¤è¾¹360åº¦è§‚æ™¯",
                    "åŸå¸‚å†å²å‘å±•é™ˆåˆ—é¦†æœ‰å¾ˆå¤šè€ä¸Šæµ·çè´µç…§ç‰‡",
                    "å¡”å†…é‚®å±€å¯ä»¥ä¹°åˆ°ç‰¹è‰²æ˜ä¿¡ç‰‡"
                ],
                "nearby_food": [
                    {"name": "ä¸œæ–¹æ˜ç æ—‹è½¬é¤å…", "type": "è§‚æ™¯é¤å…", "specialty": "è‡ªåŠ©é¤", "price": "äººå‡300+", "view": "360åº¦åŸæ™¯"},
                    {"name": "é™†å®¶å˜´æ­£å¤§å¹¿åœº", "type": "è´­ç‰©ä¸­å¿ƒ", "specialty": "å„å›½ç¾é£Ÿ", "price": "äººå‡50-200", "note": "è·ç¦»500ç±³"},
                    {"name": "IFCå›½é‡‘ä¸­å¿ƒ", "type": "é«˜ç«¯å•†åœº", "specialty": "ç²¾å“é¤å…", "price": "äººå‡200+", "note": "è·ç¦»800ç±³"},
                    {"name": "æ»¨æ±Ÿå¤§é“å°é£Ÿ", "type": "è¡—è¾¹å°é£Ÿ", "specialty": "ç®€é¤", "price": "äººå‡30-50", "note": "æ±Ÿè¾¹ç¾é£Ÿ"}
                ],
                "practical_info": {
                    "opening_hours": "8:00-21:30ï¼ˆæœ€æ™šå…¥åœº21:00ï¼‰",
                    "ticket_price": "Aç¥¨160å…ƒï¼ˆ263ç±³ï¼‰ï¼ŒBç¥¨120å…ƒï¼ˆ259ç±³ï¼‰ï¼ŒCç¥¨80å…ƒï¼ˆ220ç±³ï¼‰",
                    "transportation": ["åœ°é“2å·çº¿é™†å®¶å˜´ç«™", "è§‚å…‰å·´å£«", "è½®æ¸¡"],
                    "parking": "ä¸œæ–¹æ˜ç åœè½¦åœºï¼Œé¦–å°æ—¶å…è´¹",
                    "facilities": ["è§‚å…‰ç”µæ¢¯", "é¤å…", "çºªå¿µå“åº—", "æ´—æ‰‹é—´"]
                }
            },
            
            "ä¸Šæµ·è¿ªå£«å°¼ä¹å›­": {
                "overview": "ä¸­å›½å¤§é™†é¦–åº§è¿ªå£«å°¼ä¸»é¢˜ä¹å›­ï¼Œèåˆè¿ªå£«å°¼ç»å…¸ä¸ä¸­å›½æ–‡åŒ–ç‰¹è‰²",
                "best_time": {
                    "optimal": "å¼€å›­å‰30åˆ†é’Ÿåˆ°è¾¾",
                    "reason": "é¿å¼€äººæ½®ï¼Œç›´å¥”çƒ­é—¨é¡¹ç›®å¦‚åˆ›æé€Ÿå…‰è½®ã€é£è·ƒåœ°å¹³çº¿",
                    "alternative": "å·¥ä½œæ—¥æ¯”å‘¨æœ«äººå°‘50%ä»¥ä¸Š"
                },
                "photo_spots": [
                    {"name": "å¥‡å¹»ç«¥è¯åŸå ¡", "tip": "æ­£é¢æ‹æ‘„æœ€ç»å…¸", "best_time": "æ—©ä¸Š10ç‚¹å‰æˆ–å‚æ™š"},
                    {"name": "ç±³å¥‡å¤§è¡—", "tip": "å…¥å›­ç¬¬ä¸€æ‹ç…§ç‚¹", "best_time": "åˆšå…¥å›­æ—¶"},
                    {"name": "åˆ›æé€Ÿå…‰è½®", "tip": "ç§‘æŠ€æ„Ÿå¤–è§‚å¾ˆé…·", "best_time": "å¤œæ™šç¯å…‰æ•ˆæœæœ€ä½³"},
                    {"name": "å®è—æ¹¾æµ·ç›—èˆ¹", "tip": "å†’é™©å²›é£æ ¼", "best_time": "ç™½å¤©æ‹æ‘„ç»†èŠ‚"}
                ],
                "insider_tips": [
                    "ä¸‹è½½å®˜æ–¹APPå¯é¢„çº¦å¿«é€Ÿé€šè¡Œè¯ï¼ˆå…è´¹ï¼‰",
                    "å…¥å›­å®‰æ£€ä¸èƒ½å¸¦è‡ªæ‹æ†å’Œå¤§å‹ä¸‰è„šæ¶",
                    "å›­å†…é¤é¥®ä»·æ ¼è¾ƒé«˜ï¼Œå¯åœ¨è¿ªå£«å°¼å°é•‡ç”¨é¤",
                    "çƒŸèŠ±è¡¨æ¼”æœ€ä½³è§‚èµä½ç½®æ˜¯åŸå ¡å‰å¹¿åœº",
                    "é›¨å¤©éƒ¨åˆ†å®¤å¤–é¡¹ç›®ä¼šæš‚åœï¼Œä½†äººæµä¼šå‡å°‘"
                ],
                "hidden_gems": [
                    "åˆ›æé€Ÿå…‰è½®å¤œæ™šä½“éªŒæ¯”ç™½å¤©æ›´éœ‡æ’¼",
                    "åŠ å‹’æ¯”æµ·ç›—èˆ¹æ’é˜ŸåŒºåŸŸæœ‰å¾ˆå¤šç»†èŠ‚å¯ä»¥æ‹ç…§",
                    "å¥‡å¹»ç«¥è¯åŸå ¡å†…éƒ¨å¯ä»¥å‚è§‚ï¼Œå¾ˆå¤šäººä¸çŸ¥é“",
                    "æ™šä¸Šçš„ç¯å…‰ç§€ä»ä¸åŒè§’åº¦è§‚çœ‹æ•ˆæœä¸åŒ"
                ],
                "nearby_food": [
                    {"name": "è¿ªå£«å°¼å°é•‡", "type": "ä¸»é¢˜é¤å…", "specialty": "å„å›½æ–™ç†", "price": "äººå‡100-300", "note": "å›­å¤–ï¼Œä»·æ ¼æ¯”å›­å†…ä¾¿å®œ"},
                    {"name": "çš‡å®¶å®´ä¼šå…", "type": "å›­å†…é¤å…", "specialty": "å…¬ä¸»ä¸»é¢˜", "price": "äººå‡200+", "note": "éœ€è¦é¢„çº¦"},
                    {"name": "å¥•æ¬§æ¥å¥¥ç‰¹è±æ–¯", "type": "è´­ç‰©ä¸­å¿ƒ", "specialty": "ç¾é£Ÿå¹¿åœº", "price": "äººå‡50-150", "note": "è·ç¦»3å…¬é‡Œ"}
                ],
                "practical_info": {
                    "opening_hours": "8:00/9:00-21:00/22:00ï¼ˆå­£èŠ‚æ€§è°ƒæ•´ï¼‰",
                    "ticket_price": "å¹³æ—¥399å…ƒï¼Œé«˜å³°æœŸ599å…ƒï¼ŒèŠ‚å‡æ—¥719å…ƒ",
                    "transportation": ["åœ°é“11å·çº¿è¿ªå£«å°¼ç«™", "å…¬äº¤ç”³è¿ªä¸œè·¯ç«™"],
                    "parking": "åœè½¦è´¹100å…ƒ/å¤©",
                    "facilities": ["å¿«é€Ÿé€šè¡Œè¯", "ç«¥è½¦ç§Ÿèµ", "è½®æ¤…ç§Ÿèµ", "å¯„å­˜æœåŠ¡"]
                }
            },
            
            "è±«å›­": {
                "overview": "æ˜ä»£ç§äººèŠ±å›­ï¼Œæ±Ÿå—å¤å…¸å›­æ—ä»£è¡¨ï¼Œå‘¨è¾¹æ˜¯ä¼ ç»Ÿå•†ä¸šåŒº",
                "best_time": {
                    "optimal": "å·¥ä½œæ—¥ä¸Šåˆ9:00-11:00",
                    "reason": "æ¸¸å®¢ç›¸å¯¹è¾ƒå°‘ï¼Œå¯ä»¥é™å¿ƒæ¬£èµå›­æ—ä¹‹ç¾",
                    "alternative": "å‚æ™š17:00åï¼Œæœ‰ä¸åŒçš„å…‰å½±æ•ˆæœ"
                },
                "photo_spots": [
                    {"name": "æ¹–å¿ƒäº­", "tip": "ç»å…¸çš„ä¹æ›²æ¡¥æ‹æ‘„ç‚¹", "best_time": "ä¸Šåˆå…‰çº¿æŸ”å’Œ"},
                    {"name": "ä¸‰ç©—å ‚", "tip": "å¤å…¸å»ºç­‘ç»†èŠ‚", "best_time": "ä»»ä½•æ—¶é—´"},
                    {"name": "ç‰ç²ç‘", "tip": "å¤ªæ¹–çŸ³ç»å…¸", "best_time": "ä¾§é€†å…‰æ‹æ‘„"},
                    {"name": "åŸéšåº™", "tip": "ä¼ ç»Ÿå»ºç­‘ç¾¤", "best_time": "é¿å¼€æ­£åˆå¼ºå…‰"}
                ],
                "insider_tips": [
                    "è±«å›­é—¨ç¥¨30å…ƒï¼ŒåŸéšåº™å…è´¹",
                    "å—ç¿”é¦’å¤´åº—æ€»åº—å°±åœ¨è¿™é‡Œï¼Œä½†è¦æ’é•¿é˜Ÿ",
                    "è€åŸéšåº™å°å•†å“è´¨é‡å‚å·®ä¸é½ï¼Œæ³¨æ„ç”„åˆ«",
                    "æ˜¥èŠ‚æœŸé—´æœ‰ç‰¹è‰²ç¯ä¼šï¼Œä½†äººæµå¦‚æ½®"
                ],
                "hidden_gems": [
                    "åŸéšåº™åé¢æœ‰ä¸ªå®‰é™çš„å°å›­æ—",
                    "è±«å›­å•†åŸåœ°ä¸‹æœ‰ä¸ªå¤ç©å¸‚åœº",
                    "è€è¡—ä¸Šæœ‰å‡ å®¶ç™¾å¹´è€åº—å€¼å¾—ä¸€çœ‹",
                    "è±«å›­å¤œæ™¯ç¯å…‰å¾ˆç¾ï¼Œæ™šä¸Š7ç‚¹åå¼€å¯"
                ],
                "nearby_food": [
                    {"name": "å—ç¿”é¦’å¤´åº—", "type": "ä¼ ç»Ÿå°ç¬¼åŒ…", "specialty": "å°ç¬¼åŒ…", "price": "äººå‡50", "note": "æ€»åº—ï¼Œéœ€æ’é˜Ÿ"},
                    {"name": "ç»¿æ³¢å»Š", "type": "æœ¬å¸®èœ", "specialty": "ä¸Šæµ·èœ", "price": "äººå‡200", "note": "è€å­—å·"},
                    {"name": "è€åŸéšåº™å°åƒ", "type": "ä¼ ç»Ÿå°åƒ", "specialty": "å„ç§å°é£Ÿ", "price": "äººå‡30-80", "note": "ç§ç±»ä¸°å¯Œ"}
                ],
                "practical_info": {
                    "opening_hours": "è±«å›­8:30-17:00ï¼ŒåŸéšåº™å…¨å¤©",
                    "ticket_price": "è±«å›­30å…ƒï¼ŒåŸéšåº™å…è´¹",
                    "transportation": ["åœ°é“10å·çº¿è±«å›­ç«™", "å¤šè·¯å…¬äº¤"],
                    "parking": "å‘¨è¾¹åœè½¦ä½ç´§å¼ ï¼Œå»ºè®®å…¬å…±äº¤é€š",
                    "facilities": ["å¯¼æ¸¸æœåŠ¡", "èŒ¶å®¤", "å¤ç©åº—"]
                }
            }
        }
        
        # å®ç”¨æ—…æ¸¸è´´å£«
        self.practical_tips = {
            "weather": {
                "rainy": ["æºå¸¦é›¨å…·", "é€‰æ‹©å®¤å†…æ™¯ç‚¹", "æ³¨æ„è·¯é¢æ¹¿æ»‘", "å¤‡ç”¨é‹è¢œ"],
                "hot": ["é˜²æ™’éœœå¿…å¤‡", "å¤šè¡¥å……æ°´åˆ†", "é¿å¼€11-15ç‚¹æˆ·å¤–æ´»åŠ¨", "è½»è–„é€æ°”è¡£ç‰©"],
                "cold": ["ä¿æš–è¡£ç‰©", "çƒ­é¥®ä¿æ¸©", "å®¤å†…å¤–æ¸©å·®æ³¨æ„", "é˜²æ»‘é‹å­"],
                "windy": ["å›ºå®šå¥½å¸½å­å›´å·¾", "æ³¨æ„é«˜å¤„æ‹ç…§å®‰å…¨", "å¤´å‘æŠ¤ç†ç”¨å“"]
            },
            "crowd": {
                "high": ["é”™å³°å‡ºè¡Œ", "æå‰åœ¨çº¿è´­ç¥¨", "é€‰æ‹©éçƒ­é—¨æ™¯ç‚¹", "è€å¿ƒæ’é˜Ÿ"],
                "medium": ["é€‚å½“é¢„ç•™æ—¶é—´", "å…³æ³¨å®æ—¶äººæµ", "å‡†å¤‡æ’é˜Ÿå¨±ä¹"],
                "low": ["æŠ“ç´§æ‹ç…§æœºä¼š", "æ·±åº¦æ¸¸è§ˆ", "ä¸æ™¯ç‚¹å·¥ä½œäººå‘˜äº’åŠ¨"]
            },
            "transport": {
                "metro": ["ä¸‹è½½åœ°é“APP", "é¿å¼€æ—©æ™šé«˜å³°", "å‡†å¤‡é›¶é’±æˆ–æ‰‹æœºæ”¯ä»˜", "äº†è§£æ¢ä¹˜è·¯çº¿"],
                "taxi": ["ä½¿ç”¨æ­£è§„æ‰“è½¦è½¯ä»¶", "å‡†å¤‡ç°é‡‘", "è®°ä½ç›®çš„åœ°å…·ä½“åœ°å€", "é¿å¼€é«˜å³°æœŸ"],
                "walking": ["èˆ’é€‚çš„é‹å­", "æŸ¥çœ‹å¤©æ°”é¢„æŠ¥", "äº†è§£è·¯çº¿è·ç¦»", "æ³¨æ„å®‰å…¨"],
                "driving": ["æå‰æŸ¥çœ‹åœè½¦ä¿¡æ¯", "é¿å¼€é™è¡Œæ—¶é—´", "äº†è§£è·¯å†µ", "å‡†å¤‡åœè½¦è´¹"]
            }
        }
        
        # å­£èŠ‚æ€§å»ºè®®
        self.seasonal_advice = {
            "spring": {
                "months": [3, 4, 5],
                "weather": "æ¸©å’Œå¤šé›¨",
                "clothing": "è–„å¤–å¥—ã€é›¨å…·",
                "activities": ["èµèŠ±", "æˆ·å¤–æ‘„å½±", "å…¬å›­æ¸¸è§ˆ"],
                "special": "æ¨±èŠ±å­£ï¼ˆ3-4æœˆï¼‰"
            },
            "summer": {
                "months": [6, 7, 8],
                "weather": "ç‚çƒ­å¤šé›¨",
                "clothing": "è½»è–„è¡£ç‰©ã€é˜²æ™’ç”¨å“",
                "activities": ["å®¤å†…æ™¯ç‚¹", "å¤œæ¸¸", "æ»¨æ±Ÿæ•£æ­¥"],
                "special": "æ¢…é›¨å­£æ³¨æ„ï¼ˆ6-7æœˆï¼‰"
            },
            "autumn": {
                "months": [9, 10, 11],
                "weather": "å‡‰çˆ½å¹²ç‡¥",
                "clothing": "é•¿è¢–ã€è–„å¤–å¥—",
                "activities": ["æˆ·å¤–æ¸¸è§ˆ", "ç™»é«˜æœ›è¿œ", "åŸå¸‚æ¼«æ­¥"],
                "special": "æœ€ä½³æ—…æ¸¸å­£èŠ‚"
            },
            "winter": {
                "months": [12, 1, 2],
                "weather": "å¯’å†·æ¹¿æ¶¦",
                "clothing": "åšå¤–å¥—ã€ä¿æš–ç”¨å“",
                "activities": ["å®¤å†…æ™¯ç‚¹", "æ¸©æ³‰", "ç‰¹è‰²ç¾é£Ÿ"],
                "special": "æ˜¥èŠ‚æœŸé—´äººæµå¤§å¢"
            }
        }
        
        logger.info("ğŸ“š RAGçŸ¥è¯†åº“åˆå§‹åŒ–å®Œæˆ")
    
    def get_attraction_insights(self, attraction: str) -> Dict[str, Any]:
        """è·å–æ™¯ç‚¹æ·±åº¦æ´å¯Ÿ"""
        return self.attractions_knowledge.get(attraction, {})
    
    def get_practical_tips_by_condition(self, condition_type: str, condition_value: str) -> List[str]:
        """æ ¹æ®æ¡ä»¶è·å–å®ç”¨è´´å£«"""
        return self.practical_tips.get(condition_type, {}).get(condition_value, [])
    
    def get_seasonal_advice(self, month: int = None) -> Dict[str, Any]:
        """è·å–å­£èŠ‚æ€§å»ºè®®"""
        if month is None:
            month = datetime.now().month
        
        for season, info in self.seasonal_advice.items():
            if month in info["months"]:
                return {**info, "season": season}
        
        return {}
    
    def search_knowledge(self, query: str, attraction: str = None) -> Dict[str, Any]:
        """æœç´¢ç›¸å…³çŸ¥è¯†"""
        results = {
            "attraction_info": {},
            "tips": [],
            "seasonal": {},
            "relevance_score": 0
        }
        
        query_lower = query.lower()
        
        # å¦‚æœæŒ‡å®šäº†æ™¯ç‚¹ï¼Œè·å–è¯¥æ™¯ç‚¹ä¿¡æ¯
        if attraction and attraction in self.attractions_knowledge:
            results["attraction_info"] = self.attractions_knowledge[attraction]
            results["relevance_score"] += 50
        
        # æœç´¢ç›¸å…³è´´å£«
        for tip_category, tips in self.practical_tips.items():
            for tip_type, tip_list in tips.items():
                if tip_type in query_lower or tip_category in query_lower:
                    results["tips"].extend(tip_list)
                    results["relevance_score"] += 10
        
        # æ·»åŠ å­£èŠ‚æ€§å»ºè®®
        results["seasonal"] = self.get_seasonal_advice()
        
        return results
    
    def generate_personalized_recommendations(self, user_preferences: Dict[str, Any], 
                                           weather_condition: str, crowd_level: str) -> List[str]:
        """ç”Ÿæˆä¸ªæ€§åŒ–æ¨è"""
        recommendations = []
        
        # åŸºäºå¤©æ°”çš„å»ºè®®
        weather_tips = self.get_practical_tips_by_condition("weather", weather_condition.lower())
        recommendations.extend([f"ğŸŒ¤ï¸ å¤©æ°”å»ºè®®ï¼š{tip}" for tip in weather_tips[:2]])
        
        # åŸºäºäººæµçš„å»ºè®®
        crowd_tips = self.get_practical_tips_by_condition("crowd", crowd_level.lower())
        recommendations.extend([f"ğŸ‘¥ äººæµå»ºè®®ï¼š{tip}" for tip in crowd_tips[:2]])
        
        # åŸºäºç”¨æˆ·åå¥½çš„å»ºè®®
        if user_preferences.get("activity") == "æ‘„å½±":
            recommendations.append("ğŸ“¸ æ‘„å½±è´´å£«ï¼šé¿å¼€æ­£åˆå¼ºå…‰ï¼Œé€‰æ‹©ä¾§é€†å…‰æˆ–æŸ”å’Œå…‰çº¿")
        
        if user_preferences.get("budget") == "ç»æµ":
            recommendations.append("ğŸ’° çœé’±è´´å£«ï¼šé€‰æ‹©å·¥ä½œæ—¥å‡ºè¡Œï¼Œå…³æ³¨å›¢è´­ä¼˜æƒ ")
        
        return recommendations

# å…¨å±€å®ä¾‹
rag_kb = RAGKnowledgeBase()

def get_rag_knowledge() -> RAGKnowledgeBase:
    """è·å–RAGçŸ¥è¯†åº“å®ä¾‹"""
    return rag_kb

if __name__ == "__main__":
    # æµ‹è¯•RAGçŸ¥è¯†åº“
    kb = RAGKnowledgeBase()
    
    print("=== RAGçŸ¥è¯†åº“æµ‹è¯• ===")
    
    # æµ‹è¯•æ™¯ç‚¹æ´å¯Ÿ
    waitan_info = kb.get_attraction_insights("å¤–æ»©")
    print(f"å¤–æ»©ä¿¡æ¯: {json.dumps(waitan_info, ensure_ascii=False, indent=2)}")
    
    # æµ‹è¯•å®ç”¨è´´å£«
    rainy_tips = kb.get_practical_tips_by_condition("weather", "rainy")
    print(f"é›¨å¤©è´´å£«: {rainy_tips}")
    
    # æµ‹è¯•å­£èŠ‚å»ºè®®
    seasonal = kb.get_seasonal_advice()
    print(f"å½“å‰å­£èŠ‚å»ºè®®: {seasonal}")
